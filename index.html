<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="game-engine-origin" content="http://www.isogenicengine.com">
	<meta http-equiv="X-UA-Compatible" content="IE=9" >
	<title>Lizards and Meerkats</title>

	<!-- STYLES -->
	<!--<link href="css/default.css" rel="stylesheet" type="text/css" />-->
    <link href="css/custom-theme/jquery-ui-1.10.3.custom.css" rel="stylesheet">
	<link href='http://fonts.googleapis.com/css?family=Freckle+Face' rel='stylesheet' type='text/css'>

    <style>
	
		body, .ui-widget {
			font-family: 'Freckle Face', cursive;
		}
	
        #blocker {

            position: absolute;

            width: 100%;
            height: 100%;

            background-color: rgba(0,0,0,0.5);

            z-index: 10000;

            font-size: 1.0em;
        }

        #blocker .ui-button {
            font-size: 0.7em;
        }

        #instructions {

            width: 100%;
            height: 100%;

            display: -webkit-box;
            display: -moz-box;
            display: box;

            -webkit-box-orient: horizontal;
            -moz-box-orient: horizontal;
            box-orient: horizontal;

            -webkit-box-pack: center;
            -moz-box-pack: center;
            box-pack: center;

            -webkit-box-align: center;
            -moz-box-align: center;
            box-align: center;

            color: #ffffff;
            text-align: center;

            cursor: pointer;

        }

        #gameMenu {
            width: 200px;
            position: absolute;
            top: 150px;
            left: 50%;
            margin-left: -103px;
            font-size: 12px;
        }

        #interface {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0px;
            left: 0px;

            z-index: 100;
        }

        #blockbar {
            position: absolute;
            left: 50%;
            top: 50%;
            margin-left: -63px;
            margin-top: -100px;
            opacity: 0.6;
        }

        #blockbar > * {
            position: absolute;
            left: 0px;
            right: 0px;
        }

        #healthbar {
            position: absolute;
            left: 30px;
            bottom: 30px;
            width: 240px;
            height: 20px;
        }
        #healthbar > * {
            position: absolute;
            top: 0px;
            left: 0px;
            width: 240px;
            height: 100%;
            text-align: center;
            text-shadow: 0 0 0.2em #F87, 0 0 0.2em #F87;
            color: rgb(80, 9, 9);
        }

        #goldHarvestElement, #commanderChangeNotificationElement {
            color: #ffff00;
            font-weight: bold;
            font-size: 2.4em;
            position: absolute;
			text-align: center;
            top: 50%;
			width: 100%;
            margin-top: -40px;
            padding-top: 40px;
            opacity: 1;
            text-shadow: 0.05em 0.05em 0.1em rgb(122, 91, 24);
        }
		
		#commanderChangeNotificationElement {
			font-size: 3em;
            margin-top: -40px;
			top: 15%;
		}

        #statusbar {
            position: absolute;
            top: 0px;
            left: 0px;
            width: 100%;
            height: 30px;
            background-color: rgba(153, 102, 0, .3);
            font-size: 30px;
            padding: 0px 10px;
        }

        #buildMenu {
            position: absolute;
            border: 1px solid #999999;
            width: 200px;
            right: 20px;
            bottom: 50px;
            display: none;
        }

        .spellSlot {
            position: relative;
            width: 50px;
            height: 50px;
            float: left;
            border: 1px solid #444444;
            text-align: center;
            font-size: 11px;
            color: #f3d35f;
        }
        .spellSlotPressed {
            border-color: #e46922;
            color: #e46922;
        }

        .keyShortcutLabel {
            position: absolute;
            right: 5px;
            bottom: 5px;
            font-size: 10px;
            color: white;
        }

        #voiceCommands {
            float: right;
            height: 100%;
            overflow: visible;
            font-size: 0.8em;
            padding: 0 0.2em;
            width: 10.5em;
        }
        #voiceCommands > div {
            background-color: rgba(153, 102, 0, .3);
            border: 1px solid rgb(153, 102, 0);
            padding: 0 0.2em;
            display: none;
        }

        #reviveCountdown {
            position: absolute;
            top: 40%;
            width: 100%;
            margin-top: -20px;
            font-size: 2em;
            color: red;
            text-align: center;
            display: none;
        }

        #minimap {
            background-image: url(./assets/heightmaps/Botswana.png);
            background-size: 100% 100%;
            position: absolute;
            left: 50%;
            top: 50%;
            margin-top: -200px;
            margin-left: -200px;
            width: 400px;
            height: 400px;
            border: 1px solid black;
        }
        .minimapBuilding {
            position: absolute;
            width: 20px;
            height: 20px;
            opacity: 0.7;
            cursor: pointer;
        }
        .minimapBuilding:hover {
            opacity: 1.0;
            width: 24px;
            height: 24px;
            margin-left: -2px;
            margin-top: -2px;
            background-size: 24px 24px;
        }
        #minimapBuildingmainBuildingLizards {
            background-image: url(./assets/ui/minimap_mainBuildingLizards.png);
        }
        #minimapBuildingmainBuildingMeerkats {
            background-image: url(./assets/ui/minimap_mainBuildingMeerkats.png);
        }
    </style>
    <!-- Isogenic Loader -->
    <!-- <script type="text/javascript">var igeRoot = './ige/engine/';</script>
     <script type="text/javascript" src="./ige/engine/loader.js"></script>-->
     <script type="text/javascript">var igeRoot = './ige2912/engine/';</script>
     <script type="text/javascript" src="./ige2912/engine/loader.js"></script>
    <script type="text/javascript" src="jquery-2.0.3.js"></script>
    <script type="text/javascript" src="jquery-ui-1.10.3.custom.js"></script>
    <script src='sounds/webaudiox.lineout.js'></script>
    <script src='sounds/webaudiox.loadbuffer.js'></script>
    <script src='sounds/webaudiox.three.js'></script>

    <script type="x-shader/x-vertex" id="grassvertexshader">

        uniform float zoom;

        attribute float atlasIndex;

        varying vec2 vUv;
        //varying float grassViewHeight;
        varying float viewHeight;

        const float imageSize = 128.0;
        const float imagesOnAtlas = 2.0;
        const float PI = 3.14159265358979323846264;

        void main() {

        float y = floor(atlasIndex / imagesOnAtlas);
        vUv = vec2( (atlasIndex - y * imagesOnAtlas) / imagesOnAtlas, y / imagesOnAtlas );

        vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );
		
		//if (length( mvPosition.xyz ) < 10.0) discard;

        viewHeight = cos(atan(abs(cameraPosition.y - position.y) / length(position.xz - cameraPosition.xz)));

        gl_PointSize = zoom * ( 180.0 / length( mvPosition.xyz ) );

        gl_Position = projectionMatrix * mvPosition;

        }

    </script>

    <script type="x-shader/x-fragment" id="grassfragmentshader">

        //uniform sampler2D grassAtlas;
        uniform sampler2D atlas;

        varying vec2 vUv;

        //varying float grassViewHeight;
        varying float viewHeight;

        const float imagesOnAtlas = 2.0;

        void main() {
            //if (gl_PointCoord.y < grassViewHeight) {
            if (gl_PointCoord.y < viewHeight) {
                gl_FragColor = texture2D(atlas, vec2( (gl_PointCoord.x / imagesOnAtlas) + vUv.s, ((gl_PointCoord.y / imagesOnAtlas) / viewHeight) + vUv.t ) );
                //gl_FragColor = texture2D(grassAtlas, vec2( (gl_PointCoord.x / imagesOnAtlas) + vUv.s, ((gl_PointCoord.y / imagesOnAtlas) / grassViewHeight) + vUv.t ) );
                //gl_FragColor = texture2D(grassAtlas, vUv );
            } else {
                gl_FragColor.r = 1.0;
                gl_FragColor.g = 1.0;
                gl_FragColor.b = 1.0;
                gl_FragColor.a = 0.0;
            }
        }

    </script>
</head>
<body>
    <div class="igeLoading loadingFloat">
        <div class="loadingLogo"></div>
        <div class="loadingCircle"></div>
        <div class="loadingCircleInner"></div>
        <div class="loadingText" id="loadingText">
            Loading
        </div>
        <div id="loadingProgress">
            <div id="loadingProgressBar"></div>
        </div>
    </div>
    <div class="igeLoading loadingLink">
        Powered By Isogenic Game Engine
        <a href="http://www.isogenicengine.com" target="_blank">http://www.isogenicengine.com</a>
    </div>


    <div id="blocker">

        <div id="gameMenu">
            <li><a href="#"><span class="ui-icon ui-icon-carat-1-e"></span>Start vote</a>
				<ul style="width: 140px;">
					<li><a href="#" onclick="javascript:ige.client.startVote('impeach')"><span class="ui-icon ui-icon-carat-1-e"></span>Impeach commander</a></li>
				</ul>
			</li>
            <li><a href="#" onclick="javascript:ige._player.takeCommander()"><span class="ui-icon ui-icon-carat-1-e"></span>Take Commander</a></li> <!-- class="ui-state-disabled" -->
            <li><a href="#" onclick="javascript:UI.options.openDialog()"><span class="ui-icon ui-icon-gear"></span>Options</a></li>
        </div>

        <div id="instructions">
            <span style="font-size:40px">Click to play</span>
            <br />
            (W,A,S,D = Move, SPACE = Jump, MOUSE = Look, CLICK = Punch)
        </div>

        <div id="options-dialog">
            <p>
                Sound: <button id="options_mute"></button>
            </p>
        </div>

        <div id="minimap">

        </div>

    </div>

    <div id="interface">

        <div id="statusbar">
            <span id="resource1">0</span> <img src="./assets/ui/icon_gold.png" />
            <span id="resource2">0</span> <img src="./assets/ui/icon_wood.png" />

            <div id="voiceCommands">
                Voice Commands (V)
                <div>
                    1. Vie for attention<br />
                    2. Question, insecurity<br />
                    3. Warning shout<br />
                    4. Cry for help<br />
                    5. Excitement, panic<br />
                    6. Chatter<br />
                </div>
            </div>
        </div>
		
		<div id="vote-dialog" title="Impeach commander?">
		  <p></p>
		</div>

        <div id="blockbar" style="width: 126px; height: 40px;">
            <img src="./assets/ui/blockbar_outer.png" style="width: 100%; height: 100%;" />
            <div id="blockbarInner" style="background-image: url(./assets/ui/blockbar_inner.png); width: 126px; height:100%; background-size: 126px 40px; background-repeat: no-repeat;"></div>
        </div>
        <div id="goldHarvestElement"></div>
		<div id="commanderChangeNotificationElement"></div>

        <div id="healthbar">
            <div id="healthbarInner" style="background-color: #FF3300;"></div>
            <img src="assets/ui/progressbarOverlay.png" />
        </div>

        <div id="buildMenu">
            <div class="spellSlot" style="background-image: url(./assets/ui/buildingLizardsMain.jpg);"><br />Outpost</div>
            <div class="spellSlot"><br />Refinery</div>
        </div>

        <div id="reviveCountdown">
            0
        </div>
    </div>
</body>
</html>
<script type="text/javascript">
    var UI = {
        blockBar: {
            el: $('#blockbar'),
            currentWidth: 126,
            setPercent: function(percent) {
                if (percent < 100) {
                    this.el.css('opacity', 0.6);
                    if (this.opacityCounter) clearTimeout(this.opacityCounter);
                } else if(!this.opacityCounter && this.currentWidth != 126) {
                    this.opacityCounter = setTimeout(function() {
                        this.el.css('opacity', 0);
                        this.opacityCounter = undefined;
                    }.bind(this), 500);
                }
                this.currentWidth = 126/100*percent;
                $('#blockbarInner').css('width', this.currentWidth);
            }
        },
        notifications: {
            displayHarvest: function(amount) {
                $('#goldHarvestElement')
                    .finish()
                    .html(amount)
                    .css('opacity', 1)
                    .animate({
                        'padding-top': 0,
                        'opacity': 0
                    },
                    200,
                    function() {
                        $('#goldHarvestElement').css('padding-top', '40px');
                    }
                );
            },
			commanderChange: function(val) {
				$('#commanderChangeNotificationElement')
                    .finish()
                    .html(val == false ? 'Your commander has resigned!' : 'Player "' + val + '" is your new commander!')
                    .css('opacity', 1);
				setTimeout(function() {
					$('#commanderChangeNotificationElement')	
						.animate({
							'padding-top': 0,
							'opacity': 0
						},
						1000,
						function() {
							$('#commanderChangeNotificationElement').css('padding-top', '40px');
						}
					);
				}, 2000);
			}
        },
        healthBar: {
            //health will be sent with commands, not streamed. Health regen is done by periodicals both on server and client. Only heals and dmgs are sent and informed about.
            el: $('#healthbarInner'),
            maxvalue: 300,
            setValue: function(value) {
                this.el.css('width', 240/this.maxvalue*value).html(Math.round(value));
            }
        },
		buildingMenu: {
			displayPressed: function(key, isPressed) {
                if (isPressed) {
				    $('#buildMenu div:nth-child('+key+')').addClass('spellSlotPressed');
                } else {
                    $('#buildMenu div:nth-child('+key+')').removeClass('spellSlotPressed');
                }
			},
            display: function(isDisplayed) {
                $('#buildMenu').css('display', isDisplayed ? 'block' : 'none');
            }
		},
        voiceCommands: {
            display: function(isDisplayed) {
                $('#voiceCommands > div').css('display', isDisplayed ? 'block' : 'none');
            }
        },
		voting: {
			openDialog: function(data) {
				var title = '', text = '', no = 'No (F2)', yes = 'Yes (F3)',
					onNo = function(){}, onYes = function(){};
				switch (data.t) {
					case 'impeach':
						title = data.p + ' requests an impeach!';
						text = 'Should the current commander be relieved from his burden?';
						onNo = function() {
							$( this ).dialog( "close" );
						};
						onYes = function() {
							$( this ).dialog( "close" );
						};
					break;
				}
		
				$( "#vote-dialog" ).dialog({
					resizable: false,
					height: "auto",
					modal: false,
					title: title,
					buttons: {
						"No (F2)": onNo,
						"Yes (F3)": onYes
					}
				})
				.dialog("open")
				.children('p')
				.html(text);
			}
		},
        options: {
            openDialog: function() {
                $( "#options-dialog" ).dialog("open");
            },
            sound: true
        },
		resources: {
			setResource: function(nr, amount) {
				$('#resource'+nr).html(amount);
			}
		},
        spawn: {
            _reviveInterval: undefined,
            dying: function(reviveTimeout) {
                var reviveCount = reviveTimeout;
                var reviveEl = $('#reviveCountdown').css('display', 'block').html(reviveCount);
                this._reviveInterval = setInterval(function() {
                    reviveCount--;
                    if (reviveCount > 0) {
                        reviveEl.html(reviveCount);
                    } else {
                        this.goToSpawnScreen();
                    }
                }.bind(this), 1000);
            },
            _cancelDying: function() {
                clearInterval(this._reviveInterval);
                $('#reviveCountdown').css('display', 'none');
            },
            goToSpawnScreen: function() {
                this._cancelDying();
                document.exitPointerLock();
                UI.minimap.show();
            }
        },
        minimap: {
            levelDimensions: 0,
            setBuilding: function(id, x, y) {
                var buildingMinimapElement = $('#minimapBuilding' + id);
                if (buildingMinimapElement.length == 0) {
                    buildingMinimapElement = $('<div id="minimapBuilding' + id + '" class="minimapBuilding"></div>');
                    buildingMinimapElement.on('click', this.selectBuilding);
                    $('#minimap').append(buildingMinimapElement);
                }
                buildingMinimapElement
                        .css('left', (x + this.levelDimensions / 2) / this.levelDimensions * 400 - 10)
                        .css('top', (y + this.levelDimensions / 2) / this.levelDimensions * 400 - 10);
            },
            selectBuilding: function() {
                ige._player.spawn(this.id.substring(15));
            },
            hide: function() {
                $('#minimap').css('display', 'none');
            },
            show: function() {
                $('#minimap').css('display', 'block');
            }
        },
        igeLoadedFunctions: function() {

            ige.client.vp1.on('pointerLockEntered', function() {
                blocker.style.display = 'none';
            });

            ige.client.vp1.on('pointerLockLeft', function() {

                blocker.style.display = '-webkit-box';
                blocker.style.display = '-moz-box';
                blocker.style.display = 'box';

                instructions.style.display = '';

                if (UI.spawn._reviveInterval != undefined) UI.spawn.goToSpawnScreen();
            });

        }
    };

    $(function() {

        $( "#gameMenu" ).menu();
        $.each($('#buildMenu div.spellSlot'), function(index, el) {
            $(el).append('<span class="keyShortcutLabel">'+(index + 1)+'</span>');
        });

        $( "#options-dialog" ).dialog({
            resizable: false,
            height: "auto",
            modal: false,
            title: "Options",
            appendTo: "#blocker",
            buttons: {
                "Close": function() {
                    $( this ).dialog( "close" );
                }
            }
        })
        .dialog("close");

        $( "#options_mute").button({
            label: "Unmute",
            icons: {
                primary: "ui-icon-volume-on"
            }
        }).on('click', function() {
            if (ige.client._sound) {
                $(this).button({
                    label: UI.options.sound ? "Muted" : "Unmuted2",
                    icons: {
                        primary: "ui-icon-volume-" + (UI.options.sound ? "off" : "on")
                    }
                });
                ige.client._sound.lineOut.toggleMute();
                UI.options.sound = !UI.options.sound;
            }
        });
    });

</script>